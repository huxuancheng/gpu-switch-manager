#!/bin/bash
# GPU 切换脚本 v3 - 整合电源管理和黑名单配置（需要重启）

# 移除 set -e 以避免非致命错误导致脚本退出

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# NVIDIA 设备 ID
NVIDIA_VGA="10de:2206"
NVIDIA_AUDIO="10de:1aef"

# 配置文件路径
VFIO_CONF="/etc/modprobe.d/vfio.conf"
VFIO_OPTIONS="/etc/modprobe.d/vfio-pci-options.conf"
BLACKLIST_CONF="/etc/modprobe.d/blacklist-nouveau.conf"
GRUB_CONF="/etc/default/grub"

# 备份目录
BACKUP_DIR="/etc/gpu-switch-backup"

# 跳过确认标志
NO_CONFIRM=false

# 日志函数
log() {
    echo -e "$1"
}

log_error() {
    echo -e "${RED}[错误] $1${NC}" >&2
}

log_success() {
    echo -e "${GREEN}[成功] $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}[警告] $1${NC}"
}

log_info() {
    echo -e "${BLUE}[信息] $1${NC}"
}

# 备份配置文件
backup_config() {
    local config_file="$1"
    if [ -f "$config_file" ]; then
        mkdir -p "$BACKUP_DIR"
        local timestamp=$(date +%Y%m%d_%H%M%S)
        local backup_file="$BACKUP_DIR/$(basename $config_file).$timestamp.bak"
        cp "$config_file" "$backup_file"
        log_info "已备份: $config_file -> $backup_file"
    fi
}

# 检查命令是否存在
check_command() {
    if ! command -v "$1" >/dev/null 2>&1; then
        log_error "未找到命令: $1"
        return 1
    fi
    return 0
}

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}错误: 请使用 sudo 运行此脚本${NC}"
    exit 1
fi

# 询问确认
confirm_reboot() {
    if [ "$NO_CONFIRM" = true ]; then
        return 0
    fi
    echo -e "${YELLOW}⚠️  切换 GPU 模式需要重启系统才能生效${NC}"
    echo -e "${YELLOW}⚠️  请保存所有未保存的工作${NC}"
    echo ""
    read -p "确认继续并重启系统? (yes/no): " answer
    if [ "$answer" != "yes" ]; then
        echo "已取消"
        exit 0
    fi
}

# 获取当前模式
get_mode() {
    if grep -q "vfio-pci.ids" $VFIO_CONF 2>/dev/null && \
       ! grep -q "^##options vfio-pci" $VFIO_CONF 2>/dev/null; then
        echo "passthrough"
    else
        echo "normal"
    fi
}

# 显示当前状态
show_status() {
    current=$(get_mode)
    echo -e "\n${GREEN}=== GPU 当前模式 ===${NC}"
    if [ "$current" = "passthrough" ]; then
        echo "模式: ${RED}直通模式${NC} (VFIO - 需要重启后生效)"
    else
        echo "模式: ${GREEN}正常使用${NC} (NVIDIA - 需要重启后生效)"
    fi

    echo -e "\n${YELLOW}当前运行状态:${NC}"
    if lsmod | grep -q "^nvidia "; then
        echo "  驱动: NVIDIA 驱动已加载"
    else
        echo "  驱动: NVIDIA 驱动未加载"
    fi
    if lsmod | grep -q "^vfio"; then
        echo "  VFIO: VFIO 模块已加载"
    else
        echo "  VFIO: VFIO 模块未加载"
    fi

    echo -e "\n${YELLOW}配置文件状态:${NC}"
    if [ -f $VFIO_OPTIONS ] && grep -q "^options vfio-pci" $VFIO_OPTIONS; then
        echo "  VFIO 电源管理: ${GREEN}已配置 (disable_idle_d3=1 disable_aspm=1)${NC}"
    else
        echo "  VFIO 电源管理: ${RED}未配置${NC}"
    fi

    if [ -f $BLACKLIST_CONF ] && grep -q "^blacklist nouveau" $BLACKLIST_CONF; then
        echo "  NVIDIA 黑名单: ${GREEN}已配置${NC}"
    else
        echo "  NVIDIA 黑名单: ${RED}未配置${NC}"
    fi
    echo ""
}

# 创建黑名单配置
setup_blacklist() {
    echo "  配置 NVIDIA 驱动黑名单..."
    cat > $BLACKLIST_CONF << 'EOF'
# 阻止 nouveau 驱动（开源NVIDIA驱动）
blacklist nouveau
options nouveau modeset=0

# 阻止 nvidia 驱动（专有驱动）
blacklist nvidia
blacklist nvidia-drm
blacklist nvidia-modeset
EOF
}

# 创建 VFIO 电源管理配置
setup_vfio_options() {
    echo "  配置 VFIO 电源管理参数..."
    cat > $VFIO_OPTIONS << EOF
# 强制对特定设备禁用 ASPM 和电源管理
options vfio-pci ids=$NVIDIA_VGA,$NVIDIA_AUDIO disable_idle_d3=1 disable_aspm=1
EOF
}

# 配置直通模式（需要重启）
enable_passthrough() {
    confirm_reboot

    echo -e "\n${YELLOW}正在配置直通模式...${NC}"

    # 检查必要命令
    check_command grub-mkconfig || return 1
    check_command mkinitcpio || return 1

    # 备份配置文件
    backup_config "$VFIO_CONF"
    backup_config "$BLACKLIST_CONF"
    backup_config "$VFIO_OPTIONS"
    backup_config "$GRUB_CONF"

    # 启用 vfio.conf
    echo "  配置 VFIO..."
    if [ -f "$VFIO_CONF" ]; then
        sed -i 's/^##options/options/' $VFIO_CONF
    else
        echo "options vfio-pci ids=$NVIDIA_VGA,$NVIDIA_AUDIO" > $VFIO_CONF
    fi

    # 设置黑名单
    setup_blacklist

    # 设置 VFIO 电源管理
    setup_vfio_options

    # 检查并添加 IOMMU 参数到 grub
    if ! grep -q "intel_iommu=on\|amd_iommu=on" $GRUB_CONF; then
        echo "  配置 IOMMU 到 GRUB..."
        sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="\(.*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 intel_iommu=on amd_iommu=on"/' $GRUB_CONF
    fi

    # 添加 pcie_aspm=off 到 GRUB（解决 D3cold 问题）
    if ! grep -q "pcie_aspm=off" $GRUB_CONF; then
        echo "  配置 PCIe ASPM 到 GRUB..."
        sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="\(.*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 pcie_aspm=off"/' $GRUB_CONF
    fi

    # 重建 GRUB 和 initramfs
    echo "  更新 GRUB..."
    if ! grub-mkconfig -o /boot/grub/grub.cfg 2>&1; then
        log_error "GRUB 更新失败"
        return 1
    fi

    echo "  更新 initramfs..."
    if ! mkinitcpio -P 2>&1; then
        log_error "initramfs 更新失败"
        return 1
    fi

    echo -e "\n${GREEN}✓ 直通模式配置完成${NC}"
    echo -e "${BLUE}包含以下配置:${NC}"
    echo "  - NVIDIA 驱动黑名单"
    echo "  - VFIO 电源管理禁用 (disable_idle_d3=1 disable_aspm=1)"
    echo "  - IOMMU 支持"
    echo "  - PCIe ASPM 禁用"
    echo -e "${BLUE}系统将在 5 秒后重启...${NC}"
    echo "按 Ctrl+C 取消"
    sleep 5
    reboot
}

# 配置正常模式（需要重启）
enable_normal() {
    confirm_reboot

    echo -e "\n${YELLOW}正在配置正常模式...${NC}"

    # 检查必要命令
    check_command grub-mkconfig || return 1
    check_command mkinitcpio || return 1

    # 备份配置文件
    backup_config "$VFIO_CONF"
    backup_config "$BLACKLIST_CONF"
    backup_config "$VFIO_OPTIONS"
    backup_config "$GRUB_CONF"

    # 禁用 vfio.conf
    echo "  禁用 VFIO 配置..."
    if [ -f "$VFIO_CONF" ]; then
        sed -i 's/^options/##options/' $VFIO_CONF
    fi

    # 禁用黑名单配置
    echo "  禁用 NVIDIA 黑名单..."
    if [ -f "$BLACKLIST_CONF" ]; then
        sed -i 's/^blacklist/#blacklist/' $BLACKLIST_CONF
        sed -i 's/^options nouveau/#options nouveau/' $BLACKLIST_CONF
    fi

    # 禁用 VFIO 电源管理
    echo "  禁用 VFIO 电源管理配置..."
    if [ -f "$VFIO_OPTIONS" ]; then
        sed -i 's/^options vfio-pci/#options vfio-pci/' $VFIO_OPTIONS
    fi

    # 从 grub 移除 IOMMU 参数（使用更精确的 sed）
    echo "  从 GRUB 移除 IOMMU 参数..."
    if [ -f "$GRUB_CONF" ]; then
        # 一次性移除多个参数
        sed -i \
            -e 's/intel_iommu=on amd_iommu=on //' \
            -e 's/intel_iommu=on //' \
            -e 's/amd_iommu=on //' \
            -e 's/pcie_aspm=off //' \
            $GRUB_CONF
    fi

    # 重建 GRUB 和 initramfs
    echo "  更新 GRUB..."
    if ! grub-mkconfig -o /boot/grub/grub.cfg 2>&1; then
        log_error "GRUB 更新失败"
        return 1
    fi

    echo "  更新 initramfs..."
    if ! mkinitcpio -P 2>&1; then
        log_error "initramfs 更新失败"
        return 1
    fi

    echo -e "\n${GREEN}✓ 正常模式配置完成${NC}"
    echo -e "${BLUE}系统将在 5 秒后重启...${NC}"
    echo "按 Ctrl+C 取消"
    sleep 5
    reboot
}

# 显示帮助
show_help() {
    echo -e "${GREEN}GPU 模式切换脚本 v3${NC} - ${YELLOW}需要重启生效${NC}"
    echo -e "\n新功能:"
    echo "  - 集成 NVIDIA 驱动黑名单管理"
    echo "  - 集成 VFIO 电源管理禁用 (解决 D3cold 问题)"
    echo "  - 自动配置 PCIe ASPM 禁用"
    echo -e "\n用法: $0 [命令] [选项]\n"
    echo "命令:"
    echo "  status      显示当前 GPU 模式配置"
    echo "  passthrough 配置为直通模式（需要重启）"
    echo "  normal      配置为正常模式（需要重启）"
    echo "  help        显示此帮助信息"
    echo ""
    echo "选项:"
    echo "  --no-confirm 跳过确认提示（用于 GUI 调用）"
    echo ""
    echo -e "${YELLOW}注意: 切换模式前请保存所有工作，系统会自动重启${NC}"
}

# 主程序
# 解析选项
while [[ $# -gt 0 ]]; do
    case $1 in
        --no-confirm)
            NO_CONFIRM=true
            shift
            ;;
        *)
            COMMAND="$1"
            shift
            ;;
    esac
done

case "${COMMAND:-status}" in
    status)
        show_status
        ;;
    passthrough|pt)
        show_status
        enable_passthrough
        ;;
    normal|nm)
        show_status
        enable_normal
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}错误: 未知命令 '$COMMAND'${NC}"
        show_help
        exit 1
        ;;
esac
