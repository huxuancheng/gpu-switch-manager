#!/bin/bash
# GPU 切换脚本 - 在直通模式和正常模式之间切换（需要重启）

# 移除 set -e 以避免非致命错误导致脚本退出

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# NVIDIA 设备 ID
NVIDIA_VGA="10de:2206"
NVIDIA_AUDIO="10de:1a86"

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}错误: 请使用 sudo 运行此脚本${NC}"
    exit 1
fi

# 询问确认
confirm_reboot() {
    echo -e "${YELLOW}⚠️  切换 GPU 模式需要重启系统才能生效${NC}"
    echo -e "${YELLOW}⚠️  请保存所有未保存的工作${NC}"
    echo ""
    read -p "确认继续并重启系统? (yes/no): " answer
    if [ "$answer" != "yes" ]; then
        echo "已取消"
        exit 0
    fi
}

# 获取当前模式
get_mode() {
    if grep -q "vfio-pci.ids" /etc/modprobe.d/vfio.conf 2>/dev/null && \
       ! grep -q "^##options vfio-pci" /etc/modprobe.d/vfio.conf 2>/dev/null; then
        echo "passthrough"
    else
        echo "normal"
    fi
}

# 显示当前状态
show_status() {
    current=$(get_mode)
    echo -e "\n${GREEN}=== GPU 当前模式 ===${NC}"
    if [ "$current" = "passthrough" ]; then
        echo "模式: ${RED}直通模式${NC} (VFIO - 需要重启后生效)"
    else
        echo "模式: ${GREEN}正常使用${NC} (NVIDIA - 需要重启后生效)"
    fi

    echo -e "\n${YELLOW}当前运行状态:${NC}"
    if lsmod | grep -q "^nvidia "; then
        echo "  驱动: NVIDIA 驱动已加载"
    else
        echo "  驱动: NVIDIA 驱动未加载"
    fi
    if lsmod | grep -q "^vfio"; then
        echo "  VFIO: VFIO 模块已加载"
    else
        echo "  VFIO: VFIO 模块未加载"
    fi
    echo ""
}

# 配置直通模式（需要重启）
enable_passthrough() {
    confirm_reboot

    echo -e "\n${YELLOW}正在配置直通模式...${NC}"

    VFIO_CONF="/etc/modprobe.d/vfio.conf"
    GRUB_CONF="/etc/default/grub"

    # 启用 vfio.conf
    echo "  配置 VFIO..."
    sed -i 's/^##options/options/' $VFIO_CONF 2>/dev/null || echo "options vfio-pci ids=$NVIDIA_VGA,$NVIDIA_AUDIO" > $VFIO_CONF

    # 检查并添加 IOMMU 参数到 grub
    if ! grep -q "iommu" $GRUB_CONF; then
        echo "  配置 IOMMU 到 GRUB..."
        sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="\(.*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 intel_iommu=on amd_iommu=on"/' $GRUB_CONF
    fi

    # 重建 GRUB 和 initramfs
    echo "  更新 GRUB..."
    grub-mkconfig -o /boot/grub/grub.cfg
    echo "  更新 initramfs..."
    mkinitcpio -P

    echo -e "\n${GREEN}✓ 直通模式配置完成${NC}"
    echo -e "${BLUE}系统将在 5 秒后重启...${NC}"
    echo "按 Ctrl+C 取消"
    sleep 5
    reboot
}

# 配置正常模式（需要重启）
enable_normal() {
    confirm_reboot

    echo -e "\n${YELLOW}正在配置正常模式...${NC}"

    VFIO_CONF="/etc/modprobe.d/vfio.conf"
    GRUB_CONF="/etc/default/grub"

    # 禁用 vfio.conf
    echo "  禁用 VFIO 配置..."
    sed -i 's/^options/##options/' $VFIO_CONF 2>/dev/null

    # 从 grub 移除 IOMMU 参数
    echo "  从 GRUB 移除 IOMMU 参数..."
    sed -i 's/intel_iommu=on amd_iommu=on //' $GRUB_CONF 2>/dev/null || true
    sed -i 's/intel_iommu=on //' $GRUB_CONF 2>/dev/null || true
    sed -i 's/amd_iommu=on //' $GRUB_CONF 2>/dev/null || true

    # 重建 GRUB 和 initramfs
    echo "  更新 GRUB..."
    if ! grub-mkconfig -o /boot/grub/grub.cfg 2>&1; then
        echo -e "${RED}GRUB 更新失败，请检查配置${NC}"
        exit 1
    fi
    echo "  更新 initramfs..."
    if ! mkinitcpio -P 2>&1; then
        echo -e "${RED}initramfs 更新失败，请检查配置${NC}"
        exit 1
    fi

    echo -e "\n${GREEN}✓ 正常模式配置完成${NC}"
    echo -e "${BLUE}系统将在 5 秒后重启...${NC}"
    echo "按 Ctrl+C 取消"
    sleep 5
    reboot
}

# 显示帮助
show_help() {
    echo -e "${GREEN}GPU 模式切换脚本${NC} - ${YELLOW}需要重启生效${NC}"
    echo -e "\n用法: $0 [命令]\n"
    echo "命令:"
    echo "  status      显示当前 GPU 模式配置"
    echo "  passthrough 配置为直通模式（需要重启）"
    echo "  normal      配置为正常模式（需要重启）"
    echo "  help        显示此帮助信息"
    echo ""
    echo -e "${YELLOW}注意: 切换模式前请保存所有工作，系统会自动重启${NC}"
}

# 主程序
case "${1:-status}" in
    status)
        show_status
        ;;
    passthrough|pt)
        show_status
        enable_passthrough
        ;;
    normal|nm)
        show_status
        enable_normal
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}错误: 未知命令 '$1'${NC}"
        show_help
        exit 1
        ;;
esac
