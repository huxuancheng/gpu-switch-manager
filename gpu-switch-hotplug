#!/bin/bash
# GPU 热切换脚本 - 无需重启（需要 IOMMU 已启用）

# 移除 set -e 以避免非致命错误导致脚本退出

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# NVIDIA 设备信息
NVIDIA_VGA="10de:2206"
NVIDIA_AUDIO="10de:1a86"
GPU_BUS="0000:02:00.0"
AUDIO_BUS="0000:02:00.1"

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}错误: 请使用 sudo 运行此脚本${NC}"
    exit 1
fi

# 检查 IOMMU
check_iommu() {
    if [ ! -d /sys/kernel/iommu_groups ]; then
        echo -e "${RED}错误: IOMMU 未启用${NC}"
        echo -e "${YELLOW}请先在 /etc/default/grub 中添加: intel_iommu=on amd_iommu=on${NC}"
        echo -e "${YELLOW}然后运行: sudo grub-mkconfig -o /boot/grub/grub.cfg && sudo mkinitcpio -P${NC}"
        echo -e "${YELLOW}最后重启系统${NC}"
        return 1
    fi
    return 0
}

# 获取当前模式
get_mode() {
    driver=$(lspci -nnk -d $NVIDIA_VGA | grep "Kernel driver in use" | awk '{print $5}')
    if [ "$driver" = "vfio-pci" ]; then
        echo "passthrough"
    elif [ "$driver" = "nvidia" ]; then
        echo "normal"
    else
        echo "unknown"
    fi
}

# 显示当前状态
show_status() {
    current=$(get_mode)
    echo -e "\n${GREEN}=== GPU 状态 ===${NC}"

    # IOMMU 状态
    if [ -d /sys/kernel/iommu_groups ]; then
        echo -e "IOMMU: ${GREEN}已启用${NC}"
    else
        echo -e "IOMMU: ${RED}未启用${NC}"
    fi

    # GPU 模式
    if [ "$current" = "normal" ]; then
        echo "模式: ${GREEN}正常使用${NC} (NVIDIA 驱动)"
    elif [ "$current" = "passthrough" ]; then
        echo "模式: ${GREEN}直通模式${NC} (VFIO 驱动)"
    else
        echo "模式: ${RED}未知${NC}"
    fi

    # 驱动信息
    echo -e "\n${YELLOW}当前驱动:${NC}"
    lspci -nnk -d $NVIDIA_VGA | grep "Kernel driver" || echo "  无"
    echo ""
}

# 切换到直通模式
enable_passthrough() {
    echo -e "${YELLOW}切换到直通模式...${NC}"

    # 检查 IOMMU
    check_iommu || return 1

    # 卸载 NVIDIA 驱动
    if lsmod | grep -q "^nvidia "; then
        echo "  卸载 NVIDIA 驱动..."
        # 先停止使用 GPU 的进程
        systemctl stop display-manager 2>/dev/null || true

        # 卸载模块
        rmmod nvidia_drm nvidia_modeset nvidia_uvm nvidia 2>/dev/null || {
            echo -e "${RED}  卸载失败，可能有进程正在使用 GPU${NC}"
            return 1
        }
    fi

    # 解绑并重新绑定到 vfio-pci
    echo "  绑定到 VFIO..."

    # 解绑
    if [ -e "/sys/bus/pci/drivers/nvidia/$GPU_BUS" ]; then
        echo -n "$GPU_BUS" > /sys/bus/pci/drivers/nvidia/unbind 2>/dev/null || true
    fi
    if [ -e "/sys/bus/pci/drivers/snd_hda_intel/$AUDIO_BUS" ]; then
        echo -n "$AUDIO_BUS" > /sys/bus/pci/drivers/snd_hda_intel/unbind 2>/dev/null || true
    fi

    # 等待设备释放
    sleep 1

    # 绑定到 vfio-pci
    echo "$GPU_BUS" > /sys/bus/pci/drivers/vfio-pci/bind 2>/dev/null || {
        echo -e "${RED}  绑定失败，尝试重新加载 vfio-pci 模块...${NC}"
        rmmod vfio_pci vfio vfio_iommu_type1 2>/dev/null || true
        modprobe vfio_pci ids=$NVIDIA_VGA,$NVIDIA_AUDIO
        modprobe vfio vfio_iommu_type1
        echo "$GPU_BUS" > /sys/bus/pci/drivers/vfio-pci/bind 2>/dev/null || true
    }

    # 检查结果
    if lspci -nnk -d $NVIDIA_VGA | grep -q "vfio-pci"; then
        echo -e "${GREEN}✓ 直通模式已启用${NC}"
    else
        echo -e "${RED}✗ 直通模式启用失败${NC}"
        return 1
    fi
}

# 切换到正常模式
enable_normal() {
    echo -e "${YELLOW}切换到正常模式...${NC}"

    # 检查 IOMMU
    check_iommu || return 1

    # 解绑 vfio-pci
    echo "  解绑 VFIO..."
    if [ -e "/sys/bus/pci/drivers/vfio-pci/$GPU_BUS" ]; then
        echo -n "$GPU_BUS" > /sys/bus/pci/drivers/vfio-pci/unbind 2>/dev/null || true
    fi

    # 等待设备释放
    sleep 1

    # 加载 NVIDIA 驱动
    echo "  加载 NVIDIA 驱动..."
    modprobe nvidia
    modprobe nvidia_uvm
    modprobe nvidia_modeset
    modprobe nvidia_drm

    # 检查结果
    if lsmod | grep -q "^nvidia "; then
        echo -e "${GREEN}✓ 正常模式已启用${NC}"
        echo -e "${BLUE}提示: 如果需要重启显示服务，请运行: systemctl start display-manager${NC}"
    else
        echo -e "${RED}✗ 正常模式启用失败${NC}"
        return 1
    fi
}

# 快速切换（配合 libvirt）
quick_passthrough() {
    echo -e "${BLUE}快速直通切换（配合虚拟机使用）...${NC}"

    # 检查虚拟机是否在运行
    if virsh list --all | grep -q "running"; then
        echo -e "${YELLOW}检测到有虚拟机在运行${NC}"
    fi

    enable_passthrough
    echo -e "\n${BLUE}现在可以启动虚拟机进行直通${NC}"
}

quick_normal() {
    echo -e "${BLUE}快速正常切换...${NC}"

    # 先关闭虚拟机（如果有）
    if virsh list | grep -q "running"; then
        echo -e "${YELLOW}检测到有虚拟机在运行，请先关闭${NC}"
        virsh list
        return 1
    fi

    enable_normal
}

# 显示帮助
show_help() {
    echo -e "${GREEN}GPU 热切换脚本（无需重启）${NC}"
    echo -e "\n${YELLOW}注意: 首次使用需要启用 IOMMU（需重启一次）${NC}\n"
    echo "用法: $0 [命令]\n"
    echo "命令:"
    echo "  status       显示当前 GPU 状态"
    echo "  passthrough  切换到直通模式"
    echo "  normal       切换到正常模式"
    echo "  quick-pt     快速切换到直通（配合虚拟机）"
    echo "  quick-nm     快速切换到正常"
    echo "  help         显示此帮助信息"
    echo ""
}

# 主程序
case "${1:-status}" in
    status)
        show_status
        ;;
    passthrough|pt)
        show_status
        enable_passthrough
        ;;
    normal|nm)
        show_status
        enable_normal
        ;;
    quick-pt)
        show_status
        quick_passthrough
        ;;
    quick-nm)
        show_status
        quick_normal
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}错误: 未知命令 '$1'${NC}"
        show_help
        exit 1
        ;;
esac
