#!/bin/bash
# GPU 热切换脚本（使用 pkexec）

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# NVIDIA 设备
GPU_BUS="0000:02:00.0"

get_mode() {
    driver=$(lspci -nnk -d 10de:2206 | grep "Kernel driver in use" | awk '{print $4}')
    if [ "$driver" = "vfio-pci" ]; then
        echo "passthrough"
    elif [ "$driver" = "nvidia" ]; then
        echo "normal"
    else
        echo "unknown"
    fi
}

show_status() {
    current=$(get_mode)
    echo -e "\n${GREEN}=== GPU 状态 ===${NC}"
    if [ "$current" = "normal" ]; then
        echo "模式: ${GREEN}正常使用${NC}"
    elif [ "$current" = "passthrough" ]; then
        echo "模式: ${GREEN}直通模式${NC}"
    fi
    echo ""
}

enable_passthrough() {
    echo -e "${YELLOW}切换到直通模式...${NC}"

    # 卸载 nvidia
    if lsmod | grep -q "^nvidia "; then
        echo "  卸载 NVIDIA 驱动..."
        pkexec modprobe -r nvidia_drm nvidia_modeset nvidia_uvm nvidia || {
            echo -e "${RED}  失败${NC}"
            return 1
        }
    fi

    # 绑定到 vfio-pci
    echo "  绑定到 VFIO..."
    pkexec sh -c "echo '$GPU_BUS' > /sys/bus/pci/drivers/nvidia/unbind 2>/dev/null; echo '$GPU_BUS' > /sys/bus/pci/drivers/vfio-pci/bind" || {
        echo -e "${RED}  失败${NC}"
        return 1
    }

    if lspci -nnk -d 10de:2206 | grep -q "vfio-pci"; then
        echo -e "${GREEN}✓ 直通模式已启用${NC}"
    else
        echo -e "${RED}✗ 直通模式启用失败${NC}"
        return 1
    fi
}

enable_normal() {
    echo -e "${YELLOW}切换到正常模式...${NC}"

    # 解绑 vfio-pci
    echo "  解绑 VFIO..."
    pkexec sh -c "echo '$GPU_BUS' > /sys/bus/pci/drivers/vfio-pci/unbind 2>/dev/null" || true

    # 加载 nvidia
    echo "  加载 NVIDIA 驱动..."
    pkexec modprobe nvidia nvidia_uvm nvidia_modeset nvidia_drm || {
        echo -e "${RED}  失败${NC}"
        return 1
    }

    if lsmod | grep -q "^nvidia "; then
        echo -e "${GREEN}✓ 正常模式已启用${NC}"
    else
        echo -e "${RED}✗ 正常模式启用失败${NC}"
        return 1
    fi
}

case "${1:-status}" in
    status)
        show_status
        ;;
    passthrough|pt)
        show_status
        enable_passthrough
        ;;
    normal|nm)
        show_status
        enable_normal
        ;;
    *)
        echo "用法: $0 [status|passthrough|normal]"
        exit 1
        ;;
esac
